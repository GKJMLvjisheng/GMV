<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cascv.oas.server.blockchain.mapper.OasDetailMapper">
 
 <resultMap id="BaseResultMap" type="com.cascv.oas.server.blockchain.model.OasDetail" >
    <id column="uuid" property="uuid" jdbcType="VARCHAR" />
    <result column="user_uuid" property="userUuid" jdbcType="VARCHAR" />
    <result column="value" property="value" jdbcType="DECIMAL" />
    <result column="extra" property="extra" jdbcType="DECIMAL" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="type" property="type" jdbcType="INTEGER" />
    <result column="tx_hash" property="txHash" jdbcType="VARCHAR" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="created" property="created" jdbcType="VARCHAR" />
    <result column="updated" property="updated" jdbcType="VARCHAR" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    uuid, user_uuid, value, extra, status, type, tx_hash, remark, created, updated
  </sql>

  <insert id="insertSelective" parameterType="com.cascv.oas.server.blockchain.model.OasDetail" >
    insert into oas_detail
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="uuid != null" >
        uuid,
      </if>
      <if test="userUuid != null" >
        user_uuid,
      </if>
      <if test="value != null" >
        value,
      </if>
      <if test="extra != null" >
        extra,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="txHash != null" >
        tx_hash,
      </if>
      <if test="remark != null" >
        remark,
      </if>
      <if test="created != null" >
        created,
      </if>
      <if test="updated != null" >
        updated,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="uuid != null" >
        #{uuid,jdbcType=VARCHAR},
      </if>
      <if test="userUuid != null" >
        #{userUuid,jdbcType=VARCHAR},
      </if>
      <if test="value != null" >
        #{value,jdbcType=DECIMAL},
      </if>
      <if test="extra != null" >
        #{extra,jdbcType=DECIMAL},
      </if>
      <if test="status != null" >
        #{status,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        #{type,jdbcType=INTEGER},
      </if>
      <if test="txHash != null" >
        #{txHash,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="created != null" >
        #{created,jdbcType=VARCHAR},
      </if>
      <if test="updated != null" >
        #{updated,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  
  <sql id="Oas_Detail_Info" >
    a.uuid, a.value, a.extra, a.status, a.remark,DATE_FORMAT(a.created,"%Y-%m-%d %H:%i:%s")as created,b.name as userName
  </sql>
  
  <select id="getAllWithdrawRecord" resultType="com.cascv.oas.server.blockchain.model.OasDetailResp">
  	select <include refid="Oas_Detail_Info" /> 
  	from oas_detail a 
  	left join user_info b 
  	on a.user_uuid = b.uuid
  	where a.type = '1'
  	order by a.created desc
  	limit #{offset},#{limit}
  </select>
  
  <select id="getAllWithdrawRecordCount" resultType="java.lang.Integer">
    select count(*)
  	from oas_detail a 
  	left join user_info b 
  	on a.user_uuid = b.uuid
  	where a.type = '1'
  </select>
  
  <select id="getOasExtra" resultType="java.lang.String">
  	select value from oas_extra_cost where code=#{code}
  </select> 
  
  <update id="updateOasExtra">
  <!-- 	update oas_extra_cost
  	set value = #{value,jdbcType=VARCHAR},
  	updated = #{updated,jdbcType=VARCHAR}
  	where code='oas_extra' -->
  	update oas_extra_cost
  	set value = CASE code
	WHEN 'oas_extra' THEN #{detail.value}
	WHEN 'oas_max' THEN #{detail.valueMax}
	WHEN 'oas_min' THEN #{detail.valueMin}
	END,
	updated = CASE code
		WHEN 'oas_extra' THEN #{updated}
		WHEN 'oas_max' THEN #{updated}
		WHEN 'oas_min' THEN #{updated}
	END
	WHERE code in ('oas_extra','oas_max','oas_min')
  </update>
  
  <select id="getRecordByUuid" resultMap="BaseResultMap">
  	select <include refid="Base_Column_List" /> 
  	from oas_detail
  	where uuid = #{uuid,jdbcType=VARCHAR}
  </select>
  
  <update id="setWithdrawResultByUuid">
   update oas_detail
   <set> 
   	  <if test="result != null" >
        status = #{result,jdbcType=INTEGER},
      </if>
      <if test="updated != null" >
        updated = #{updated,jdbcType=VARCHAR},
      </if>
   	  <if test="txHash != null" >
        tx_hash = #{txHash,jdbcType=VARCHAR},
      </if>
   </set>
   where uuid = #{uuid,jdbcType=VARCHAR}
  </update>
  
  <select id="getOasDetailByHash" resultMap="BaseResultMap">
  	select <include refid="Base_Column_List" /> 
  	from oas_detail
  	where 1=1
  	<if test="txHash != null" >
     and tx_hash = #{txHash,jdbcType=VARCHAR},
    </if>
  </select>
  
  <select id="getSystemUserInfo" resultType="com.cascv.oas.server.user.model.UserModel">
   select * from user_info
   where name = 'SYSTEM' limit 1
  </select>
  <select id="getAdminUserInfo" resultType="com.cascv.oas.server.user.model.UserModel">
   select * from user_info
   where name = 'ADMIN' limit 1
  </select>
  
  <select id="getFirstOneUserInfo" resultType="com.cascv.oas.server.user.model.UserModel">
   select * from user_info
   where name = 'FIRSTONE' limit 1
  </select>

   <update id="updateRecordByHash" parameterType="com.cascv.oas.server.blockchain.model.OasDetail" >
    update oas_detail
    <set >
      <if test="userUuid != null" >
        user_uuid = #{userUuid,jdbcType=VARCHAR},
      </if>
      <if test="value != null" >
        value = #{value,jdbcType=DECIMAL},
      </if>
      <if test="extra != null" >
        extra = #{extra,jdbcType=DECIMAL},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="created != null" >
        created = #{created,jdbcType=VARCHAR},
      </if>
      <if test="updated != null" >
        updated = #{updated,jdbcType=VARCHAR},
      </if>
    </set>
    where tx_hash = #{txHash,jdbcType=VARCHAR} and uuid= #{uuid,jdbcType=VARCHAR}
  </update>
  
  <select id="selectRecordByHash" resultMap="BaseResultMap">
  	select  <include refid="Base_Column_List" />
  	from  oas_detail
  	where tx_hash = #{txHash,jdbcType=VARCHAR}
  	and (status =1 or status = 0)
  	limit 1
  </select>
  
  <update id="updateStatusByUuid">
  	update oas_detail 
  	set status = #{status,jdbcType=INTEGER}
  	where uuid = #{uuid,jdbcType=VARCHAR}
  </update>
</mapper>
