<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cascv.oas.server.blockchain.mapper.UserWalletTradeRecordMapper">

  <resultMap id="UserWalletTradeRecordMap" type="com.cascv.oas.server.blockchain.wrapper.UserWalletTradeRecordInfo">
	<result column="name" property="name"/>
	<result column="value" property="value"/>
	<result column="title" property="title"/>
	<result column="sub_title" property="subTitle"/>
	<result column="created" property="created"/>
	<result column="remark" property="remark"/>
	<result column="rest_balance" property="restBalance"/>
  </resultMap>

  <select id="selectAllTradeRecordBySearchValue" resultMap="UserWalletTradeRecordMap">
select 
	  u.name,ud.value,ud.title,ud.created,ud.remark,ud.rest_balance,ud.sub_title
from 
	  user_wallet_detail ud left join user_info u on ud.user_uuid=u.uuid
       	   <if test="searchValue != null and searchValue !='' ">
    		where u.name like concat('%',#{searchValue},'%')
    		or ud.value like concat('%',#{searchValue},'%')
    		or ud.title like concat('%',#{searchValue},'%')
    		or ud.created like concat('%',#{searchValue},'%')
    		or ud.remark like concat('%',#{searchValue},'%')
    		or ud.sub_title like concat('%',#{searchValue},'%')
    		or ud.rest_balance like concat('%',#{searchValue},'%')
       </if>
order by ud.created desc
limit #{offset}, #{limit};
</select>

<select id="countByTradeRecordBySearchValue" resultType="java.lang.Integer">
select 
	  count(*)
from 
	  user_wallet_detail ud left join user_info u on ud.user_uuid=u.uuid
	  <if test="searchValue != null and searchValue !='' ">
    		where u.name like concat('%',#{searchValue},'%')
    		or ud.value like concat('%',#{searchValue},'%')
    		or ud.title like concat('%',#{searchValue},'%')
    		or ud.created like concat('%',#{searchValue},'%')
    		or ud.remark like concat('%',#{searchValue},'%')
    		or ud.sub_title like concat('%',#{searchValue},'%')
    		or ud.rest_balance like concat('%',#{searchValue},'%')
       </if>
</select>

<resultMap id="walletTotalTradeRecordMap" type="com.cascv.oas.server.blockchain.wrapper.WalletTotalTradeRecordInfo">
    <result column="name" property="name"/>
	<result column="value" property="value"/>
</resultMap> 
 
<select id="selectAllInTotalTradeRecordBySearchValue" resultMap="walletTotalTradeRecordMap">
select 
	  u.name,SUM(ud.value) as value
from 
	  user_wallet_detail ud left join user_info u on ud.in_or_out=1 and ud.user_uuid=u.uuid
where
	  DATE_FORMAT(ud.created,"%Y-%m-%d") BETWEEN #{startTime} and #{endTime}
      <if test="searchValue != null and searchValue !='' ">
    		and u.name like concat('%',#{searchValue},'%')
    		or ud.value like concat('%',#{searchValue},'%')
       </if>
group by u.name 
order by value desc
limit #{offset}, #{limit};
</select>

<select id="countByInTotalTradeRecordBySearchValue" resultType="java.lang.Integer">
select 
	  count(distinct ud.user_uuid)
from 
	  user_wallet_detail ud left join user_info u on ud.in_or_out=1 and ud.user_uuid=u.uuid
where
	  DATE_FORMAT(ud.created,"%Y-%m-%d") BETWEEN #{startTime} and #{endTime}
	   <if test="searchValue != null and searchValue !='' ">
    		and u.name like concat('%',#{searchValue},'%')
    		or ud.value like concat('%',#{searchValue},'%')
       </if>
       ;
</select>

<select id="selectAllOutTotalTradeRecordBySearchValue" resultMap="walletTotalTradeRecordMap">
select 
	  u.name,SUM(ud.value) as value
from 
	 user_wallet_detail ud left join user_info u on ud.in_or_out=0 and ud.user_uuid=u.uuid
where
	  DATE_FORMAT(ud.created,"%Y-%m-%d") BETWEEN #{startTime} and #{endTime}
       <if test="searchValue != null and searchValue !='' ">
    		and u.name like concat('%',#{searchValue},'%')
    		or ud.value like concat('%',#{searchValue},'%')
       </if>
group by u.name 
order by value desc
limit #{offset}, #{limit};
   </select>
   
  <select id="countByOutTotalTradeRecordBySearchValue" resultType="java.lang.Integer">
select 
	  count(distinct ud.user_uuid)
from 
	   user_wallet_detail ud left join user_info u on ud.in_or_out=0 and ud.user_uuid=u.uuid
where
	  DATE_FORMAT(ud.created,"%Y-%m-%d") BETWEEN #{startTime} and #{endTime}
	   <if test="searchValue != null and searchValue !='' ">
    		and u.name like concat('%',#{searchValue},'%')
    		or ud.value like concat('%',#{searchValue},'%')
       </if>
       ;
   </select>
   
<select id="selectAllUserBalanceRecordBySearchValue" resultMap="walletTotalTradeRecordMap">
select 
	 u.name,uw.balance as value
from 
	 user_wallet uw left join user_info u on uw.user_uuid=u.uuid
	 <if test="searchValue != null and searchValue !='' ">
    		where u.name like concat('%',#{searchValue},'%')
    		or uw.balance like concat('%',#{searchValue},'%')
       </if>
order by value desc
limit #{offset}, #{limit};
   </select>
  
    <select id="countByUserBalanceRecordBySearchValue" resultType="java.lang.Integer">
select 
	 count(*)
from 
	 user_wallet uw left join user_info u on uw.user_uuid=u.uuid
	<if test="searchValue != null and searchValue !='' ">
    		where u.name like concat('%',#{searchValue},'%')
    		or uw.balance like concat('%',#{searchValue},'%')
       </if>
       ;
   </select> 
  
<select id="selectUserPointToOas" resultMap="walletTotalTradeRecordMap">
select 
	 SUM(value) as value
from 
	 user_wallet_detail
where
     user_uuid= # {userUuid} and title='积分兑换OAS代币' and DATE_FORMAT(created,"%Y-%m-%d %T") BETWEEN #{startTime} and #{endTime}
   </select> 
   
</mapper>