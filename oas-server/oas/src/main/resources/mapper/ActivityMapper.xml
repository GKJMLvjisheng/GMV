<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cascv.oas.server.activity.mapper.ActivityMapper">
    
    <resultMap id="activityMap" type="com.cascv.oas.server.activity.model.ActivityModel">
		<id column="uuid" property="sourceUuid" />
		<result column="source_code" property="sourceCode"/>
		<result column="source_name" property="sourceName"/>
		<result column="type" property="type"/>
	  	<result column="created" property="created"/>
    </resultMap>
  
    <sql id="activity_List">
  		uuid, source_code, source_name, type, created
    </sql>
    
    <!-- insert activity -->
    <insert id="insertActivity" parameterType="com.cascv.oas.server.activity.model.ActivityModel">
	    insert into activity
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        uuid, source_code, source_name,
	        <if test="type != null">
	          type,
	        </if>
	        created
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides=",">
	        #{sourceUuid},
	        #{sourceCode},
	        #{sourceName,jdbcType=VARCHAR}, 
	        <if test="type != null">
	           #{type,jdbcType=VARCHAR},
	        </if>
	        #{created,jdbcType=VARCHAR}
	    </trim>
    </insert>
    
    <select id="selectAllActivity" resultMap="activityMap">
        select
         <include refid="activity_List" />
        from activity order by source_code asc
    </select>
    
    <select id="selectActivityBySourceUuid" resultMap="activityMap">
        select
         <include refid="activity_List" />
        from activity where uuid = #{sourceUuid}
    </select>
    
    <select id="selectActivityBySourceCode" resultMap="activityMap">
        select
         <include refid="activity_List" />
        from activity where source_code = #{sourceCode}
    </select>
    
    <update id="updateSourceCode" parameterType="com.cascv.oas.server.activity.model.ActivityModel">
        update activity
        set
          source_code = #{sourceCode}
        where
          uuid = #{sourceUuid}
    </update>
    
    <delete id="deleteActivity" parameterType="com.cascv.oas.server.activity.model.ActivityModel">
        delete from activity where uuid = #{sourceUuid}
    </delete>
    
    
    <resultMap id="rewardMap" type="com.cascv.oas.server.activity.model.RewardModel">
		<id column="uuid" property="rewardUuid" />
		<result column="reward_code" property="rewardCode"/>
		<result column="reward_name" property="rewardName"/>
		<result column="reward_description" property="rewardDescription"/>
	  	<result column="created" property="created"/>
    </resultMap>
    
    <sql id="reward_List">
  		uuid, reward_code, reward_name, reward_description, created
    </sql>
    
    <!-- insert activity -->
    <insert id="insertRewardType" parameterType="com.cascv.oas.server.activity.model.RewardModel">
	    insert into reward_source
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        uuid, reward_code, reward_name,
	        <if test="rewardDescription != null">
	          reward_description,
	        </if>
	        created
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides=",">
	        #{rewardUuid},
	        #{rewardCode},
	        #{rewardName,jdbcType=VARCHAR}, 
	        <if test="rewardDescription != null">
	           #{rewardDescription,jdbcType=VARCHAR},
	        </if>
	        #{created,jdbcType=VARCHAR}
	    </trim>
    </insert>
    
    <select id="selectAllReward" resultMap="rewardMap">
        select
         <include refid="reward_List" />
        from reward_source order by reward_code asc
    </select>
    
    <select id="selectRewardByRewardCode" resultMap="rewardMap">
        select
         <include refid="reward_List" />
        from reward_source where uuid = #{rewardUuid}
    </select>
    
    <select id="selectRewardByCode" resultMap="rewardMap">
        select
         <include refid="reward_List" />
        from reward_source where reward_code = #{rewardCode}
    </select>
    
    <update id="updateRewardCode" parameterType="com.cascv.oas.server.activity.model.RewardModel">
        update reward_source
        set
          reward_code = #{rewardCode}
        where
          uuid = #{rewardUuid}
    </update>
    
    <delete id="deleteReward" parameterType="com.cascv.oas.server.activity.model.RewardModel">
        delete from reward_source where uuid = #{rewardUuid}
    </delete>
    
    

  <resultMap id="activityRewardConfigMap" type="com.cascv.oas.server.activity.model.ActivityRewardConfig">
	<id column="uuid" property="uuid" />
	<result column="source_uuid" property="sourceUuid"/>
	<result column="reward_uuid" property="rewardUuid"/>
	<result column="base_value" property="baseValue"/>
  	<result column="increase_speed" property="increaseSpeed"/>
  	<result column="increase_speed_unit" property="increaseSpeedUnit"/>
  	<result column="max_value" property="maxValue"/>
  	<result column="period" property="period"/>
  	<result column="created" property="created"/>
  	<result column="updated" property="updated"/>
  </resultMap>
 
  <sql id="activity_Reward_Connfig_List">
  		uuid, source_uuid, reward_uuid, base_value, increase_speed, increase_speed_unit,
    	max_value, period, created, updated
  </sql>
  
  <!-- insert activity reward config -->
  <insert id="insertActivityRewardConfig" parameterType="com.cascv.oas.server.activity.model.ActivityRewardConfig">    
    insert into activity_reward_config
    <trim prefix="(" suffix=")" suffixOverrides=",">
      uuid, source_uuid, reward_uuid,     
      <if test="baseValue != null">
        base_value,
      </if>
      <if test="increaseSpeed != null">
        increase_speed,
      </if>
      <if test="increaseSpeedUnit != null">
        increase_speed_unit,
      </if>
      <if test="maxValue != null">
        max_value,
      </if>
      <if test="period != null">
        period,
      </if>
        created, updated
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
        #{uuid,jdbcType=VARCHAR},
        #{sourceUuid}, 
        #{rewardUuid},
        
        <if test="baseValue != null">
	       #{baseValue, jdbcType=DECIMAL},
	    </if>
        <if test="increaseSpeed != null">
           #{increaseSpeed,jdbcType=DECIMAL},
        </if>
        <if test="increaseSpeedUnit != null">
           #{increaseSpeedUnit,jdbcType=VARCHAR},
        </if>
	    
	       #{maxValue,jdbcType=DECIMAL},
	   
	    <if test="period != null">
	       #{period},
	    </if>
        
        #{created,jdbcType=VARCHAR},
        #{updated,jdbcType=VARCHAR}
    </trim>
   </insert>
   
  
  <!-- select activity max_value -->
  <select id="selectBaseValueBySourceCodeAndRewardCode" resultMap="activityRewardConfigMap">
      select 
      <include refid="activity_Reward_Connfig_List" />
      from activity_reward_config where source_uuid = #{sourceUuid} and reward_uuid = #{rewardUuid};
  </select> 
  
  <delete id="deleteActivityReward" parameterType="com.cascv.oas.server.activity.model.ActivityRewardConfig">
      delete from activity_reward_config where source_uuid = #{sourceUuid} and reward_uuid = #{rewardUuid};
  </delete>
  
  <!-- update activity reward-->
  <update id="updateActivityReward" parameterType="com.cascv.oas.server.activity.model.ActivityRewardConfig">
      update activity_reward_config
      set
          base_value = #{baseValue},
          increase_speed = #{increaseSpeed},
          increase_speed_unit = #{increaseSpeedUnit},
          max_value = #{maxValue},
          period = #{period},
          updated = #{updated}
       where source_uuid = #{sourceUuid} and reward_uuid = #{rewardUuid}
          
  </update>
  
  
  <resultMap id="rewardConfigResult" type="com.cascv.oas.server.activity.wrapper.RewardConfigResult">
	<id column="uuid" property="uuid" />
	<id column="user_uuid" property="userUuid" />
	<result column="source_uuid" property="sourceUuid"/>
	<result column="reward_uuid" property="rewardUuid"/>
	<result column="reward_name" property="rewardName"/>
	<result column="base_value" property="baseValue"/>
  	<result column="increase_speed" property="increaseSpeed"/>
  	<result column="increase_speed_unit" property="increaseSpeedUnit"/>
  	<result column="max_value" property="maxValue"/>
  	<result column="period" property="period"/>
  	<result column="created" property="created"/>
  	<result column="updated" property="updated"/>
  </resultMap>
  
  <!-- select all activityReward -->
  <select id="selectActivityRewardBySourceCode" resultMap="rewardConfigResult">
      select * from activity_reward_config A 
      left join reward_source B on A.reward_uuid = B.uuid 
      where A.source_uuid = #{sourceUuid};
  </select> 
  
  
  <select id="inquireACSByUserUuidAndSouceCode" resultMap="rewardConfigResult">
      select * from activity_completion_status  
      where source_uuid = #{sourceUuid} and user_uuid=#{userUuid};
  </select> 
  
  
  <resultMap id="EnergyPointBall" type="com.cascv.oas.server.activity.model.EnergyPointBall">
        <id column="uuid" jdbcType="VARCHAR" property="uuid"/>
        <result column="user_uuid" jdbcType="VARCHAR" property="userUuid" />
        <result column="source_uuid" jdbcType="VARCHAR" property="sourceUuid" />
        <result column="point" jdbcType="DECIMAL" property="point"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="created" jdbcType="VARCHAR" property="created"/>
        <result column="updated" jdbcType="VARCHAR" property="updated"/>
    </resultMap>
    
  <sql id="Energy_Point_Ball_List">
        uuid, user_uuid, source_uuid, point, status, created, updated
    </sql>
    <!-- 根据能量球id查询 -->
    <select id="selectByUuid" resultMap="EnergyPointBall">
        select
        <include refid="Energy_Point_Ball_List" />
        from energy_point_ball where uuid = #{uuid}
    </select>
    
    <select id="selectByPointSourceCode" resultMap="EnergyPointBall">
        select <include refid="Energy_Point_Ball_List" />
        from energy_point_ball where
        user_uuid = #{userUuid} and
        source_uuid = #{sourceUuid} and 
        status = #{status}
    </select>
    
    <select id="selectLatestOneByPointSourceCode" resultMap="EnergyPointBall">
        select <include refid="Energy_Point_Ball_List" />
        from energy_point_ball where
        user_uuid = #{userUuid} and
        source_uuid = #{sourceUuid} and 
        status = #{status}
        order by created desc limit 1
    </select>
    
    <select id="selectAllByUserUuid" resultMap="EnergyPointBall">
        select * from energy_point_ball A
         left join activity B on A.source_uuid = B.uuid
          where 
          A.user_uuid = #{userUuid} and
          A.status = #{status} and
          date_add(updated, interval 8 hour) like #{updated}"%" and
          B.type = '手机'
    </select>
    
  <!-- 插入积分球 -->
    <insert id="insertEnergyPointBall" parameterType="com.cascv.oas.server.activity.model.EnergyPointBall">
        insert into energy_point_ball (
        uuid, user_uuid, source_uuid, point, status, created, updated)
        values (
        #{uuid}, #{userUuid}, #{sourceUuid}, #{point},
        #{status}, #{created}, #{updated})
    </insert>
    
    <!-- 变更积分能量球的状态 -->
    <update id="updatePointStatusByUuid" parameterType="com.cascv.oas.server.activity.model.EnergyPointBall">
        update energy_point_ball
        set `status` = #{status}, updated = #{updated} WHERE uuid = #{uuid}
    </update>
    
    <resultMap id="EnergyPowerBall" type="com.cascv.oas.server.activity.model.EnergyPowerBall">
        <id column="uuid" jdbcType="VARCHAR" property="uuid"/>
        <result column="user_uuid" jdbcType="VARCHAR" property="userUuid" />
        <result column="source_uuid" jdbcType="VARCHAR" property="sourceUuid" />
        <result column="power" jdbcType="DECIMAL" property="power"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="created" jdbcType="VARCHAR" property="created"/>
        <result column="updated" jdbcType="VARCHAR" property="updated"/>
    </resultMap>
    
  <!-- 插入算力球 -->
    <insert id="insertEnergyPowerBall" parameterType="com.cascv.oas.server.activity.model.EnergyPowerBall">
        insert into energy_power_ball (
        uuid, user_uuid, source_uuid, power, status, created, updated)
        values (
        #{uuid}, #{userUuid}, #{sourceUuid}, #{power},
        #{status}, #{created}, #{updated})
    </insert>
    
    <!-- 变更算力能量球的状态 -->
    <update id="updatePowerStatusByUuid" parameterType="com.cascv.oas.server.activity.model.EnergyPowerBall">
        update energy_power_ball
        set `status` = #{status}, updated = #{updated} WHERE uuid = #{uuid}
    </update>
    
    <resultMap id="PointTradeRecord" type="com.cascv.oas.server.activity.model.PointTradeRecord">
        <id column="uuid" jdbcType="VARCHAR" property="uuid" />
        <result column="user_uuid" jdbcType="VARCHAR" property="userUuid" />
        <result column="energy_ball_uuid" jdbcType="VARCHAR" property="energyBallUuid" />
        <result column="in_or_out" jdbcType="INTEGER" property="inOrOut" />
        <result column="point_change" jdbcType="DECIMAL" property="pointChange"/>
        <result column="status" jdbcType="INTEGER" property="status" />
        <result column="created" jdbcType="VARCHAR" property="created"/>
        <result column="rest_point" jdbcType="DECIMAL" property="restPoint"/>
    </resultMap>

    <!-- 插入积分记录 -->
    <insert id="insertPointTradeRecord" parameterType="com.cascv.oas.server.activity.model.PointTradeRecord">
       insert into point_trade_record (
        uuid,
        user_uuid,
        energy_ball_uuid,
        in_or_out,
        point_change,
        status,
        <if test="restPoint != null">
    		rest_point,
    	</if>
        created
        )
        values (
        #{uuid},
        #{userUuid},
        #{energyBallUuid},
        #{inOrOut},
        #{pointChange},
        #{status},
        <if test="restPoint != null">
    		#{restPoint,jdbcType=DECIMAL},
    	</if>
        #{created})
    </insert>
    
    <resultMap id="PowerTradeRecord" type="com.cascv.oas.server.activity.model.PowerTradeRecord">
        <id column="uuid" jdbcType="VARCHAR" property="uuid" />
        <result column="user_uuid" jdbcType="VARCHAR" property="userUuid" />
        <result column="energy_ball_uuid" jdbcType="VARCHAR" property="energyBallUuid" />
        <result column="in_or_out" jdbcType="INTEGER" property="inOrOut" />
        <result column="power_change" jdbcType="DECIMAL" property="powerChange"/>
        <result column="status" jdbcType="INTEGER" property="status" />
        <result column="created" jdbcType="VARCHAR" property="created"/>
    </resultMap>

    <!-- 插入算力记录 -->
    <insert id="insertPowerTradeRecord" parameterType="com.cascv.oas.server.activity.model.PowerTradeRecord">
        insert into power_trade_record (
        uuid, user_uuid, energy_ball_uuid, in_or_out, power_change, status, created)
        values (
        #{uuid}, #{userUuid}, #{energyBallUuid}, #{inOrOut}, #{powerChange},
        #{status}, #{created})
    </insert>
    
    
    
    <resultMap id="EnergyWall" type="com.cascv.oas.server.energy.model.EnergyWallet">
        <id column="uuid" property="uuid"/>
        <result column="user_uuid" property="userUuid"/>
        <result column="point" property="point" jdbcType="DECIMAL"/>
        <result column="power" property="power" jdbcType="DECIMAL"/>
        <result column="created" property="created"/>
        <result column="updated" property="updated"/>
    </resultMap>
    
    <update id="increasePoint" >
      update energy_wallet set point=point + #{value}, updated = #{updated} where user_uuid = #{userUuid}
    </update>

    <update id="decreasePoint">
      update energy_wallet set point=point - #{value}, updated = #{updated} where user_uuid = #{userUuid}
    </update>

    <update id="increasePower">
      update energy_wallet set power=power + #{value}, updated = #{updated} where user_uuid = #{userUuid}
    </update>

    <update id="decreasePower">
      update energy_wallet set power=power - #{value}, updated = #{updated} where user_uuid = #{userUuid}
    </update>
    
  
    
    <resultMap id="ActivityCompletionStatus" type="com.cascv.oas.server.energy.model.ActivityCompletionStatus">
        <id column="uuid" property="uuid"/>
        <result column="user_uuid" property="userUuid"/>
        <result column="status" property="status"/>
        <result column="source_uuid" property="sourceUuid"/>
        <result column="created" property="created"/>
        <result column="updated" property="updated"/>
    </resultMap>
    
  <insert id="insertActivityCompletionStatus" parameterType="com.cascv.oas.server.energy.model.ActivityCompletionStatus">
      insert into activity_completion_status 
      (uuid, user_uuid, source_uuid, status, created, updated)
      values (#{uuid}, #{userUuid}, #{sourceUuid}, #{status}, #{created}, #{updated})
  </insert>
    
</mapper>