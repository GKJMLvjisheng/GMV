<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cascv.oas.server.miner.mapper.MinerMapper">
    
    <resultMap id="MinerMap" type="com.cascv.oas.server.miner.model.MinerModel">
		<id column="miner_code" property="minerCode" />
		<result column="miner_name" property="minerName"/>
	  	<result column="miner_description" property="minerDescription"/>
	  	<result column="miner_price" property="minerPrice"/>
	  	<result column="miner_grade" property="minerGrade"/>
	  	<result column="miner_power" property="minerPower"/>
	  	<result column="miner_period" property="minerPeriod"/>
	  	<result column="created" property="created"/>
	  	<result column="updated" property="updated"/>
    </resultMap>
        
    <sql id="miner_List">
  		miner_code, miner_name, miner_grade, miner_description, miner_price, miner_power, miner_period, created, updated
    </sql>
    
    <insert id="insertMiner" parameterType="com.cascv.oas.server.miner.model.MinerModel">
        insert into miner_source
        <trim prefix="(" suffix=")" suffixOverrides=",">
	        miner_code, miner_name, miner_grade,
	        <if test="minerDescription != null">
	          miner_description,
	        </if>
	         miner_price, miner_power, miner_period, created, updated
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides=",">
	        #{minerCode}, #{minerName}, #{minerGrade},
	        <if test="minerDescription != null">
	           #{minerDescription},
	        </if>
	        #{minerPrice}, #{minerPower}, #{minerPeriod}, #{created}, #{updated}
	    </trim>            
    </insert>
    
    <select id="selectAllMiner" resultMap="MinerMap">
        select
         <include refid="miner_List" />
         from miner_source 
         order by updated desc limit #{offset}, #{limit}
    </select>
    
    <select id="selectAllWebMiner" resultMap="MinerMap">
        select
         <include refid="miner_List" />
         from miner_source 
         order by updated desc
    </select>
    
    <select id="inquireByMinerName" resultMap="MinerMap">
        select * from miner_source where miner_name = #{minerName}
    </select>
    
    <select id="inquireByUuid" resultMap="MinerMap">
        select * from miner_source where miner_code = #{minerCode}
    </select>
    
    <select id="inquireUpdateMinerName" resultMap="MinerMap">
        select b.* from 
          (select * from miner_source
            where miner_name not in (select miner_name from miner_source where miner_name=#{minerName}))b
        where b.miner_name = #{updateMinerName}
    </select>
    
    <select id="countNum" resultType="java.lang.Integer">
  	    select count(*) from miner_source
    </select>
    
    <update id="updateMiner" parameterType="com.cascv.oas.server.miner.model.MinerModel">
        update miner_source
        set
          miner_name = #{minerName},
          miner_description = #{minerDescription},
          miner_power = #{minerPower},
          miner_price = #{minerPrice},
          miner_grade = #{minerGrade},
          miner_period = #{minerPeriod},
          updated = #{updated}
        where
          miner_code = #{minerCode}
    </update>
    
    <delete id="deleteMiner">
        delete from miner_source where miner_code=#{minerCode}
    </delete>    
    
    <resultMap id="purchaseRecordMap" type="com.cascv.oas.server.miner.model.PurchaseRecord">
        <result column="uuid" property="uuid"/>
		<result column="user_uuid" property="userUuid"/>
		<result column="miner_code" property="minerCode"/>
		<result column="miner_name" property="minerName"/>
	  	<result column="miner_description" property="minerDescription"/>
	  	<result column="miner_price" property="minerPrice"/>
	  	<result column="miner_grade" property="minerGrade"/>
	  	<result column="miner_num" property="minerNum"/>
	  	<result column="price_sum" property="priceSum"/>
	  	<result column="miner_power" property="minerPower"/>
	  	<result column="miner_period" property="minerPeriod"/>
	  	<result column="miner_status" property="minerStatus"/>
	  	<result column="created" property="created"/>
    </resultMap>
    
    <sql id="purchase_record_List">
  		uuid, user_uuid, miner_code, miner_name, miner_grade, 
  		miner_description, miner_price, miner_num, price_sum,
  		miner_power, miner_period, miner_status, created
    </sql>
    
    <insert id="insertPurchaseRecord" parameterType="com.cascv.oas.server.miner.model.PurchaseRecord">
        insert into purchase_record
        <trim prefix="(" suffix=")" suffixOverrides=",">
	        uuid, user_uuid, miner_code, miner_name, miner_grade,
	        <if test="minerDescription != null">
	          miner_description,
	        </if>
	         miner_price, miner_num, price_sum, miner_power, miner_period, miner_status, created
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides=",">
	        #{uuid}, #{userUuid}, #{minerCode}, #{minerName}, #{minerGrade},
	        <if test="minerDescription != null">
	           #{minerDescription},
	        </if>
	        #{minerPrice}, #{minerNum}, #{priceSum}, #{minerPower}, #{minerPeriod}, #{minerStatus}, #{created}
	    </trim>            
    </insert>
    
    <select id="selectByuserUuid" resultMap="purchaseRecordMap">
        select <include refid="purchase_record_List" /> from purchase_record 
        where user_uuid=#{userUuid}
    </select>
    
    <select id="selectAllRecord" resultMap="purchaseRecordMap">
        select <include refid="purchase_record_List" /> from purchase_record
        where miner_status = 1
    </select>
    
    <select id="countByUserUuid" resultType="java.lang.Integer">
  	    select count(*) from purchase_record where user_uuid = #{userUuid}
    </select>
    
    <select id="inquerePurchaseRecord" resultMap="purchaseRecordMap">
        select
         <include refid="purchase_record_List" />
         from purchase_record where user_uuid = #{userUuid} 
         order by created desc limit #{offset}, #{limit}
    </select>
    
    <update id="updateStatusByUuid" parameterType="com.cascv.oas.server.miner.model.PurchaseRecord">
        update purchase_record
          set miner_status = 0 
        where uuid = #{uuid}
    </update>
    
</mapper>